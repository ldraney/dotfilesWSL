name: Release Trigger
on:
  release:
    types: [published, released]

  # A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  init:
    runs-on: ubuntu-latest
    # This filters out pre-release releases
    if: github.event.release.prerelease == true || github.event.action == 'released'
    # when a non draft PR is created TODO test actor on new repo!!!!
    steps:
      - name: Init
        run: |
          echo Deploy starting
          echo ${{ github.actor }}

  setup-release:
    needs: [init]
    runs-on: ubuntu-latest
    outputs:
      git-tag: ${{ steps.tag.outputs.version }}
      env: ${{ steps.setup.outputs.environment }}
    steps:
      - name: Check release
        run: |
          echo "github.event.release.prerelease: ${{ github.event.release.prerelease }}"
          echo "github.event.action: ${{ github.event.action }}"
      - name: Setup Environment
        id: setup
        uses: actions/github-script@v6
        with:
          script: |
            if ('${{ github.event.release.prerelease }}' === true) {
              core.setOutput('environment', 'staging')
            }
            if ('${{ github.event.action }}' === 'released') {
              core.setOutput('environment', 'prod')
            }
            else {
              console.log('Pre-release is false. Stopping workflow.')
              process.exit(0)
            }

  run-deployment:
    needs: [setup-release]
    uses: ./.github/workflows/deployment.yml
    with:
      environment: "${{ needs.setup-release.outputs.env }}"
