name: Release and Pre-release Trigger
on:
  release:
    types: [published]

jobs:
  setup-environment:
    runs-on: ubuntu-latest
    steps:
      - name: Init
        run: |
          echo Deploy starting
          # this allows for blame
          echo ${{ github.actor }}

      - name: Checkout Repo
        uses: actions/checkout@v3
        with:
          ref: ${{ inputs.ref }}

      - name: Check release and env values
        run: |
          echo "Release tag: ${{ github.event.release.tag_name }}"	          
          echo "Release name: ${{ github.event.release.name }}"
          echo "commit-hash: $(git rev-parse HEAD)"
          echo "is a prerelease? (github.event.release.prerelease): ${{ github.event.release.prerelease }}"
          echo "is a regular release? (will say release if true)(github.event.action): ${{ github.event.action }}"

  filter-release:
    needs: [setup-environment]
    runs-on: ubuntu-latest
    steps:
      - name: Check release
        run: |
          echo "github.event.release.prerelease: ${{ github.event.release.prerelease }}"
          echo "github.event.action: ${{ github.event.action }}"
          echo "::set-output name=git-tag::version"
          echo "::set-output name=env::environment"

  pre-release:
    needs: [setup-environment]
    runs-on: ubuntu-latest
    if: github.event.release.prerelease == true
    steps:
      - name: Call pre-release workflow
        uses: ./pre-release.yml  # Use a specific branch
        with:
          environment: "staging"
          ref: "${{ needs.setup-release.outputs.git-tag }}"

  release:
    needs: [filter-release]
    runs-on: ubuntu-latest
    if: github.event.action == 'released'
    steps:
      - name: Call release workflow
        uses: .github/workflows/release.yml@master  # Use a specific branch
        with:
          environment: "prod"
          ref: "${{ needs.setup-release.outputs.git-tag }}"
